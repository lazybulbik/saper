<!doctype html>
<html>
<head>
    <title>–°–∞–ø–µ—Ä - –ö–æ–º–Ω–∞—Ç–∞ {{ room }}</title>
    <style>
        body {
            margin: 0;
            padding-bottom: 60px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ */
        }
        table { border-collapse: collapse; }
        td {
            width: 30px; height: 30px;
            text-align: center; vertical-align: middle;
            border: 1px solid #000;
            user-select: none;
        }
        .revealed { background-color: #ccc; }
        #action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            padding: 10px 0;
            border-top: 1px solid #ccc;
        }
        #action-buttons button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        .selected {
            background-color: #007BFF;
            color: white;
        }
        @media (min-width: 768px) {
            #action-buttons {
                display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
            }
            body {
                padding-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <h1>–ö–æ–º–Ω–∞—Ç–∞ {{ room }}</h1>
    <div id="game-board"></div>
    <h2>–ü–æ–ª—è –æ–ø–ø–æ–Ω–µ–Ω—Ç–æ–≤</h2>
    <div id="opponents"></div>
    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
    <div id="action-buttons">
        <button id="reveal-button" class="selected">–û—Ç–∫—Ä—ã—Ç—å</button>
        <button id="flag-button">–§–ª–∞–≥</button>
    </div>
    <script src="//code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        var socket = io();
        var room = "{{ room }}";
        var actionMode = 'reveal'; // –†–µ–∂–∏–º –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        socket.on('connect', function() {
            socket.emit('join', {'room': room});
        });

        socket.on('load_board', function(board) {
            renderBoard(board);
        });

        socket.on('update_opponents', function(boards) {
            $('#opponents').empty();
            for (var sid in boards) {
                var board = boards[sid];
                var table = $('<table></table>');
                for (var r = 0; r < board.length; r++) {
                    var tr = $('<tr></tr>');
                    for (var c = 0; c < board[r].length; c++) {
                        var td = $('<td></td>').text(board[r][c]);
                        tr.append(td);
                    }
                    table.append(tr);
                }
                $('#opponents').append(table);
            }
        });

        socket.on('game_over', function() {
            alert('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í—ã –Ω–∞—Ç–∫–Ω—É–ª–∏—Å—å –Ω–∞ –º–∏–Ω—É üí£');
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        });

        function renderBoard(board) {
            var table = $('<table></table>');
            for (var r = 0; r < board.length; r++) {
                var tr = $('<tr></tr>');
                for (var c = 0; c < board[r].length; c++) {
                    var cell = board[r][c];
                    var td = $('<td></td>')
                        .attr('id', 'cell-' + r + '-' + c)
                        .data('cell', [r, c]);

                    if (cell['revealed']) {
                        td.addClass('revealed');
                        if (cell['mine']) {
                            td.text('üí£');
                        } else {
                            td.text(cell['adjacent'] > 0 ? cell['adjacent'] : '');
                        }
                    } else if (cell['flagged']) {
                        td.text('üè¥');
                    } else {
                        td.text('');
                    }

                    td.on('click', function(e) {
                        e.preventDefault();
                        var cell = $(this).data('cell');
                        if (isMobileDevice()) {
                            if (actionMode === 'reveal') {
                                socket.emit('reveal', {'room': room, 'cell': cell});
                            } else if (actionMode === 'flag') {
                                socket.emit('flag', {'room': room, 'cell': cell});
                            }
                        } else {
                            socket.emit('reveal', {'room': room, 'cell': cell});
                        }
                    });

                    td.on('contextmenu', function(e) {
                        e.preventDefault();
                        var cell = $(this).data('cell');
                        socket.emit('flag', {'room': room, 'cell': cell});
                    });

                    tr.append(td);
                }
                table.append(tr);
            }
            $('#game-board').html(table);
        }

        function isMobileDevice() {
            return window.innerWidth < 768;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        $('#reveal-button').on('click', function() {
            actionMode = 'reveal';
            $('#reveal-button').addClass('selected');
            $('#flag-button').removeClass('selected');
        });

        $('#flag-button').on('click', function() {
            actionMode = 'flag';
            $('#flag-button').addClass('selected');
            $('#reveal-button').removeClass('selected');
        });
    </script>
</body>
</html>
